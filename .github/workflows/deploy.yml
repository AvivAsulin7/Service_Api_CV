- name: Deploy to EC2
  uses: appleboy/ssh-action@v1.0.0
  with:
    host: ${{ secrets.EC2_HOST }}
    username: ubuntu
    key: ${{ secrets.EC2_SSH_KEY }}
    script: |
      set -e  # ××¤×¡×™×§ ××ª ×”×¡×§×¨×™×¤×˜ ×× ×™×© ×©×’×™××”

      echo "ğŸ“¦ × ×›× ×¡×™× ×œ×ª×™×§×™×™×ª NGSOFT"
      cd ~/NGSOFT

      echo "ğŸ”„ ××•×©×›×™× ×§×•×“ ×-master"
      git pull origin master

      echo "ğŸ§± × ×›× ×¡×™× ×œ-front ×•××‘×¦×¢×™× build"
      cd frontend/cv-app
      npm install
      npm run build

      echo "ğŸ“‚ × ×›× ×¡×™× ×œ-backend ×•××¨×™×¦×™× ××ª ×”×©×¨×ª"
      cd ../../backend
      npm install

      echo "ğŸ›‘ ×¢×•×¦×¨×™× ×©×¨×ª ×§×•×“× ×× ×§×™×™×"
      pkill node || true
      pm2 delete all || true

      echo "ğŸš€ ××¨×™×¦×™× index.js ×¢× PM2"
      pm2 start index.js --name "cv-server"

      echo "ğŸ’¾ ×©×•××¨×™× ×ª×¦×•×¨×ª PM2"
      pm2 save

      echo "ğŸ” ××¨×¢× × ×™× ××ª NGINX"
      sudo systemctl reload nginx || true

      echo "âœ… ×¡×™×•× ×”×¤×™×™×¤×œ×™×™×Ÿ ×‘×”×¦×œ×—×”"
